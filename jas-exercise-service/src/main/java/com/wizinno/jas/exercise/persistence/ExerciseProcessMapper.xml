<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wizinno.jas.exercise.domain.ExerciseProcessMapper" >
  <resultMap id="BaseResultMap" type="com.wizinno.jas.exercise.domain.model.ExerciseProcess" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 17 13:14:19 CST 2017.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="patient_id" property="patientId" jdbcType="BIGINT" />
    <result column="doctor_id" property="doctorId" jdbcType="BIGINT" />
    <result column="arthro" property="arthro" jdbcType="INTEGER" />
    <result column="postion" property="postion" jdbcType="INTEGER" />
    <result column="direction" property="direction" jdbcType="INTEGER" />
    <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
    <result column="note" property="note" jdbcType="VARCHAR" />
    <result column="create_by" property="createBy" jdbcType="BIGINT" />
    <result column="update_by" property="updateBy" jdbcType="BIGINT" />
    <result column="sign" property="sign" jdbcType="INTEGER" />
      <result column="report" property="report" jdbcType="INTEGER" />
      <result column="record" property="record" jdbcType="INTEGER" />
      <result column="is_comfirmed" property="isComfirmed" jdbcType="INTEGER" />
      <result column="comfirmed_time" property="comfirmedTime" jdbcType="TIMESTAMP" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 17 13:14:19 CST 2017.
    -->
    delete from exercise_process
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.wizinno.jas.exercise.domain.model.ExerciseProcess" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 17 13:14:19 CST 2017.
    -->
    insert into exercise_process (id, patient_id, doctor_id, 
      arthro, postion, direction, 
      start_time, end_time, note, 
      create_by, update_by, sign, report,record,
      create_time,is_comfirmed,comfirmed_time, update_time)
    values (#{id,jdbcType=BIGINT}, #{patientId,jdbcType=BIGINT}, #{doctorId,jdbcType=BIGINT}, 
      #{arthro,jdbcType=INTEGER}, #{postion,jdbcType=INTEGER}, #{direction,jdbcType=INTEGER}, 
      #{startTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP}, #{note,jdbcType=VARCHAR}, 
      #{createBy,jdbcType=BIGINT}, #{updateBy,jdbcType=BIGINT}, #{sign,jdbcType=INTEGER}, #{report,jdbcType=INTEGER},#{record,jdbcType=INTEGER},
      #{createTime,jdbcType=TIMESTAMP}, #{isComfirmed,jdbcType=INTEGER},#{comfirmedTime,jdbcType=TIMESTAMP},#{updateTime,jdbcType=TIMESTAMP})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.wizinno.jas.exercise.domain.model.ExerciseProcess" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 17 13:14:19 CST 2017.
    -->
    update exercise_process
    set patient_id = #{patientId,jdbcType=BIGINT},
      doctor_id = #{doctorId,jdbcType=BIGINT},
      arthro = #{arthro,jdbcType=INTEGER},
      postion = #{postion,jdbcType=INTEGER},
      direction = #{direction,jdbcType=INTEGER},
      start_time = #{startTime,jdbcType=TIMESTAMP},
      end_time = #{endTime,jdbcType=TIMESTAMP},
      note = #{note,jdbcType=VARCHAR},
      create_by = #{createBy,jdbcType=BIGINT},
      update_by = #{updateBy,jdbcType=BIGINT},
      sign = #{sign,jdbcType=INTEGER},
      report = #{report,jdbcType=INTEGER},
      record = #{record,jdbcType=INTEGER},
     is_comfirmed =  #{isComfirmed,jdbcType=INTEGER},
      comfirmed_time = #{comfirmedTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 17 13:14:19 CST 2017.
    -->
    select id, patient_id, doctor_id, arthro, postion, direction, start_time, end_time, 
    note, create_by, update_by, sign, report,record,create_time, update_time,is_comfirmed,comfirmed_time
    from exercise_process
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 17 13:14:19 CST 2017.
    -->
    select id, patient_id, doctor_id, arthro, postion, direction, start_time, end_time, 
    note, create_by, update_by, sign, report,record,create_time, update_time,is_comfirmed,comfirmed_time
    from exercise_process
  </select>
<!--后台查询所有康复计划列表-->
    <select id="findExerciseProcessList" resultType="com.wizinno.jas.exercise.service.dto.ExerciseProcessDto" parameterType="com.wizinno.jas.exercise.service.dto.ExerciseProcessDto">
        select  ep.id as id,ep.patient_id as patientId, ep.arthro as arthro,ep.direction as direction,ep.postion as postion,u.real_name as patientName,
        du.real_name as doctorName,up.real_name as updateByName,ep.start_time as startTime,ep.end_time as endTime from exercise_process ep
        LEFT JOIN patient p on ep.patient_id=p.id
        LEFT JOIN doctor d on ep.doctor_id = d.id
        LEFT JOIN user u on u.id=p.user_id
        LEFT JOIN user du on d.user_id = du.id
        LEFT JOIN user up on up.id = ep.update_by
        WHERE 1=1
        <if test="id!='' and null !=id">
            and ep.id = #{id,jdbcType=BIGINT}
        </if>
        <if test="patientName!='' and null !=patientName">
          and u.real_name LIKE  concat('%',#{patientName,jdbcType=VARCHAR},'%')
        </if>
        <if test="doctorName!='' and null!=doctorName">
            and du.real_name LIKE  concat('%',#{doctorName,jdbcType=VARCHAR},'%')
        </if>
        <if test="startTime!=null and endTime!=null">
          and ep.start_time BETWEEN #{startTime,jdbcType=TIMESTAMP} and #{endTime,jdbcType=TIMESTAMP}
        </if>
    </select>

  <select id="getDoctorsByPatientId" parameterType="java.lang.Long" resultType="com.wizinno.jas.exercise.service.dto.ExerciseProcessDoctorDto">
   select  ep.patient_id as patientId, ep.doctor_id as doctorId, ep.is_comfirmed as isComfirmed,
 u.real_name as doctorName,d.department as department,d.hospital as hospital,
    d.professiona as professiona,u.sex as sex,d.description as description,u.birth_date as brith,u.open_id as openId,
    u.head_portrait as headPortRait
    from exercise_process ep
    LEFT JOIN doctor d ON ep.doctor_id = d.id
    LEFT JOIN user u ON d.user_id=u.id
    WHERE ep.patient_id = #{id,jdbcType=BIGINT} and ep.is_comfirmed = 1
    GROUP BY ep.doctor_id
  </select>

  <select id="getExerciseProcessByPatientId" resultType="com.wizinno.jas.exercise.service.dto.ExerciseProcessDto" parameterType="java.lang.Long">
    select id as id, patient_id as patientId, doctor_id as doctorId, arthro as arthro,
    postion as postion, direction as direction, start_time as startTime, end_time as endTime,is_comfirmed as isComfirmed,comfirmed_time as comfirmedTime,
    note as note, create_by as createBy, update_by as updateBy, sign as sign,report as report,record as record,
    create_time as createTime, update_time as updateTime,DATEDIFF(now(),end_time) as overdue
    from exercise_process
    WHERE patient_id = #{patientId,jdbcType=BIGINT}
  </select>

  <select id="getPatientsByPatientId" parameterType="java.lang.Long" resultType="com.wizinno.jas.exercise.service.dto.ExerciseProcessPatientDto">
 select ep.id as id, ep.patient_id as patientId, ep.doctor_id as doctorId, ep.arthro as arthro,
     ep.postion as postion, ep.direction as direction, ep.start_time as startTime, ep.end_time as endTime,
    ep.note as note,ep.sign as sign,u.real_name as patientName,
    u.sex as sex,u.birth_date as brith,u.open_id as openId
    from exercise_process ep
    LEFT JOIN patient p ON ep.patient_id = p.id
    LEFT JOIN user u ON p.user_id=u.id
     WHERE ep.patient_id = #{patientId,jdbcType=BIGINT}
  </select>

    <!--医生查询所有病人-->
    <select id="getPatientByPatientId" parameterType="map" resultType="com.wizinno.jas.exercise.service.dto.ExerciseProcessPatientDto">
       SELECT * from (SELECT ep.doctor_id as doctorId,ep.patient_id as patientId,ep.create_time as createtime,ep.comfirmed_time,
        u.real_name as userName,u.birth_date as birthDate,u.sex as sex,u.head_portrait as headPortrait,u.phone as phone, ep.start_time as startTime,
        ep.end_time as endTime,ep.id as id,ep.arthro as arthro,ep.postion as postion,ep.direction as direction,ep.note as note,u.id as userId
        FROM exercise_process ep
        inner JOIN  patient p ON p.id=ep.patient_id
        inner JOIN user u ON u.id=p.user_id
        WHERE ep.doctor_id= #{doctorId,jdbcType=BIGINT}
         <if test="filter!=null and filter!=''">
             AND u.real_name LIKE concat('%',#{filter,jdbcType=VARCHAR},'%')
         </if>
          AND ep.is_comfirmed =#{isComfirmed,jdbcType=BIGINT}
       ORDER BY ep.create_time desc) a
        <!--       GROUP BY patientId-->
            </select>

          <select id="getEPByPIdAndDId" parameterType="map" resultType="com.wizinno.jas.exercise.service.dto.ExerciseProcessDto">
                select id as id, patient_id as patientId, doctor_id as doctorId, arthro as arthro,
            postion as postion, direction as direction, start_time as startTime, end_time as endTime,
            note as note, create_by as createBy, update_by as updateBy, sign as sign,report as report,record as record,
            create_time as createTime, update_time as updateTime,DATEDIFF(now(),end_time) as overdue,is_comfirmed as isComfirmed
            from exercise_process
            where patient_id = #{patientId,jdbcType=BIGINT} AND doctor_id = #{id,jdbcType=BIGINT}
          </select>
        </mapper>